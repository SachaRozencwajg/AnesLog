{% extends "base.html" %}
{% block title %}Mon profil â€” AnesLog{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto px-4 py-8">

    <div class="mb-8">
        <h1 class="text-2xl font-bold text-gray-900">Mon profil</h1>
        <p class="text-sm text-gray-500 mt-1">GÃ©rez vos informations et paramÃ¨tres de formation</p>
    </div>

    {% if setup_mode %}
    <div class="mb-6 p-5 bg-gradient-to-r from-primary-50 to-white border border-primary-100 rounded-2xl shadow-sm">
        <h2 class="text-lg font-bold text-primary-900 mb-2 flex items-center gap-2">
            <span class="text-2xl">ðŸ‘‹</span> Bienvenue sur AnesLog !
        </h2>
        <p class="text-primary-800">Votre compte a Ã©tÃ© crÃ©Ã© avec succÃ¨s. Veuillez vÃ©rifier votre nom puis configurer
            vos semestres ci-dessous.</p>
    </div>
    {% endif %}

    {% if success %}
    <div class="mb-6 p-4 bg-green-50 border border-green-200 rounded-xl flex items-start gap-3">
        <svg class="w-5 h-5 text-green-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
        <p class="text-sm text-green-700">{{ success }}</p>
    </div>
    {% endif %}

    {% if error %}
    <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-xl flex items-start gap-3">
        <svg class="w-5 h-5 text-red-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <p class="text-sm text-red-700">{{ error }}</p>
    </div>
    {% endif %}

    <!-- â”€â”€â”€ Section 1: Identity â”€â”€â”€ -->
    <div class="bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden mb-6">
        <div class="px-6 py-4 border-b border-gray-100">
            <h2 class="text-sm font-semibold text-gray-800 uppercase tracking-wide">IdentitÃ©</h2>
        </div>
        <form method="post" action="/profil" class="p-6 space-y-5">

            <!-- Email (Read-only) -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                <input type="text" value="{{ user.email }}" disabled
                    class="w-full px-4 py-2.5 rounded-xl border border-gray-200 bg-gray-50 text-gray-500 text-sm cursor-not-allowed">
            </div>

            <!-- Full Name (Editable) -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Nom complet</label>
                <input type="text" name="full_name" value="{{ user.full_name }}" required
                    class="w-full px-4 py-2.5 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent text-sm bg-white"
                    placeholder="Dr. PrÃ©nom Nom">
                <p class="text-xs text-gray-500 mt-1">Ce nom sera affichÃ© pour vos seniors.</p>
            </div>

            <!-- Service (Read-only) -->
            <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">Service</label>
                <input type="text" value="{{ user.service.name if user.service else 'Aucun service' }}" disabled
                    class="w-full px-4 py-2 rounded-xl border border-gray-200 bg-gray-50 text-gray-500 text-sm">
            </div>

            <!-- Submit -->
            <div class="pt-1">
                <button type="submit"
                    class="w-full py-3 px-4 bg-primary-600 text-white font-semibold rounded-xl hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 transition-all shadow-sm">
                    Enregistrer
                </button>
            </div>

        </form>
    </div>

    {% if user.role.value == 'resident' %}
    <!-- â”€â”€â”€ Section 2: Semester Management â”€â”€â”€ -->
    <div class="bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
            <div>
                <h2 class="text-sm font-semibold text-gray-800 uppercase tracking-wide">Mes semestres</h2>
                <p class="text-xs text-gray-500 mt-0.5">Configurez vos stages tout au long du DESAR</p>
            </div>
            {% if current_semester %}
            <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-semibold
                {% if current_semester.phase.value == 'socle' %}bg-blue-100 text-blue-700
                {% elif current_semester.phase.value == 'approfondissement' %}bg-amber-100 text-amber-700
                {% else %}bg-emerald-100 text-emerald-700{% endif %}">
                S{{ current_semester.number }} Â· Phase {{ current_semester.phase.value | capitalize }}
            </span>
            {% elif on_break %}
            <span
                class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-semibold bg-amber-100 text-amber-700">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Intersemestre
            </span>
            {% endif %}
        </div>

        <div class="p-6">
            {% if current_semester %}
            <!-- Current semester summary -->
            <div class="mb-5 p-4 bg-primary-50 border border-primary-100 rounded-xl">
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-10 h-10 rounded-lg flex items-center justify-center text-sm font-bold
                        {% if current_semester.phase.value == 'socle' %}bg-blue-100 text-blue-700
                        {% elif current_semester.phase.value == 'approfondissement' %}bg-amber-100 text-amber-700
                        {% else %}bg-emerald-100 text-emerald-700{% endif %}">
                        S{{ current_semester.number }}
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-gray-800">
                            {% if current_semester.hospital %}{{ current_semester.hospital }}{% endif %}
                            {% if current_semester.service_name %} Â· {{ current_semester.service_name }}{% endif %}
                            {% if not current_semester.hospital and not current_semester.service_name %}Semestre
                            actuel{%
                            endif %}
                        </p>
                        <p class="text-xs text-gray-500">
                            {% if current_semester.start_date %}
                            {{ current_semester.start_date.strftime('%d/%m/%Y') }}
                            {% if current_semester.end_date %} â†’ {{ current_semester.end_date.strftime('%d/%m/%Y') }}{%
                            endif %}
                            {% endif %}
                            {% if current_semester.subdivision %} Â· {{ current_semester.subdivision }}{% endif %}
                        </p>
                    </div>
                </div>
                {% if days_remaining is not none and days_total %}
                <div class="mt-2">
                    <div class="flex justify-between text-xs text-gray-500 mb-1">
                        <span>Progression</span>
                        <span>{{ days_remaining }} jours restants</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-1.5">
                        <div class="bg-primary-500 h-1.5 rounded-full transition-all"
                            style="width: {{ ((days_elapsed / days_total) * 100) | int if days_total else 0 }}%"></div>
                    </div>
                </div>
                {% endif %}
            </div>
            {% elif on_break %}
            <!-- Inter-semester break summary -->
            <div class="mb-5 p-4 bg-gradient-to-br from-amber-50 to-orange-50 border border-amber-200 rounded-xl">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-10 h-10 rounded-lg bg-amber-100 flex items-center justify-center flex-shrink-0">
                        <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-amber-900">Intersemestre</p>
                        <p class="text-xs text-amber-700">
                            {% if last_semester %}
                            S{{ last_semester.number }} terminÃ© le {{ last_semester.end_date.strftime('%d/%m/%Y') }}
                            {% else %}
                            Vous Ãªtes entre deux stages
                            {% endif %}
                        </p>
                    </div>
                </div>
                {% if next_semester %}
                <div class="flex items-center justify-between bg-white/60 rounded-lg p-3 border border-amber-100">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded flex items-center justify-center text-xs font-bold
                            {% if next_semester.phase.value == 'socle' %}bg-blue-100 text-blue-700
                            {% elif next_semester.phase.value == 'approfondissement' %}bg-amber-100 text-amber-700
                            {% else %}bg-emerald-100 text-emerald-700{% endif %}">
                            S{{ next_semester.number }}
                        </div>
                        <div>
                            <p class="text-xs font-semibold text-gray-800">
                                {% if next_semester.hospital %}{{ next_semester.hospital }}{% endif %}
                                {% if next_semester.service_name %} Â· {{ next_semester.service_name }}{% endif %}
                                {% if not next_semester.hospital and not next_semester.service_name %}Prochain stage{%
                                endif
                                %}
                            </p>
                            {% if next_semester.start_date %}
                            <p class="text-xs text-gray-500">DÃ©but le {{ next_semester.start_date.strftime('%d/%m/%Y')
                                }}</p>
                            {% endif %}
                        </div>
                    </div>
                    {% if days_until_next is not none %}
                    <span
                        class="inline-flex items-center gap-1 px-2.5 py-1 bg-amber-100 text-amber-700 rounded-full text-xs font-bold">
                        J-{{ days_until_next }}
                    </span>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% endif %}

            <a href="/semestres"
                class="flex items-center justify-center gap-2 w-full py-3 px-4 border-2 border-dashed border-gray-300 text-gray-600 font-medium rounded-xl hover:border-primary-400 hover:text-primary-600 hover:bg-primary-50 transition-all">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                GÃ©rer mes semestres
            </a>
        </div>
    </div>
    {% endif %}

</div>
{% endblock %}