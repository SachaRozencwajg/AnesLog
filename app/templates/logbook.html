{% extends "base.html" %}
{% block title %}Mon carnet — AnesLog{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto px-4 py-6 pb-24" x-data="logbookApp()">

    <!-- Header -->
    <div class="flex items-center justify-between mb-4">
        <div>
            <h1 class="text-xl font-bold text-primary-900">Mon carnet</h1>
            <p class="text-sm text-gray-500">{{ logs|length }} résultat{{ 's' if logs|length > 1 else '' }}
                {% if selected_category or selected_autonomy or selected_semester or selected_section %}
                <span class="text-primary-600">(filtré)</span> · <a href="/mon-carnet"
                    class="text-xs text-primary-500 hover:underline">Tout afficher</a>
                {% else %}
                · {{ total_count }} acte{{ 's' if total_count > 1 else '' }} au total
                {% endif %}
            </p>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="bg-white rounded-2xl border border-surface-200 p-4 mb-5">
        <div class="flex items-center gap-2 mb-3">
            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
            </svg>
            <span class="text-xs font-semibold text-gray-600 uppercase tracking-wider">Filtres</span>
            {% if selected_category or selected_autonomy or selected_semester or selected_section %}
            <a href="/mon-carnet" class="ml-auto text-xs text-red-400 hover:text-red-600 transition">✕ Réinitialiser</a>
            {% endif %}
        </div>

        <!-- Section pills -->
        <div class="mb-3">
            <p class="text-xs text-gray-400 mb-2">Section</p>
            <div class="flex flex-wrap gap-1.5">
                <a href="/mon-carnet{% if selected_autonomy %}?autonomie={{ selected_autonomy }}{% endif %}{% if selected_semester %}{{ '&' if selected_autonomy else '?' }}semestre={{ selected_semester }}{% endif %}"
                    class="inline-flex items-center px-3 py-1.5 rounded-full text-xs font-medium transition-all
                          {% if not selected_section %}bg-primary-600 text-white shadow-sm{% else %}bg-surface-50 text-gray-500 border border-surface-200 hover:border-primary-300 hover:text-primary-600{% endif %}">
                    Toutes
                </a>
                {% for sec_key, sec_label in section_labels.items() %}
                <a href="/mon-carnet?section={{ sec_key }}{% if selected_autonomy %}&autonomie={{ selected_autonomy }}{% endif %}{% if selected_semester %}&semestre={{ selected_semester }}{% endif %}"
                    class="inline-flex items-center px-3 py-1.5 rounded-full text-xs font-medium transition-all
                          {% if selected_section == sec_key %}bg-primary-600 text-white shadow-sm{% else %}bg-surface-50 text-gray-500 border border-surface-200 hover:border-primary-300 hover:text-primary-600{% endif %}">
                    {{ sec_label }}
                </a>
                {% endfor %}
            </div>
        </div>

        <!-- Category pills -->
        <div class="mb-3 pt-3 border-t border-surface-100">
            <p class="text-xs text-gray-400 mb-2">Catégorie</p>
            <div class="flex flex-wrap gap-1.5">
                <a href="/mon-carnet{% if selected_section %}?section={{ selected_section }}{% endif %}{% if selected_autonomy %}{{ '&' if selected_section else '?' }}autonomie={{ selected_autonomy }}{% endif %}{% if selected_semester %}{{ '&' if selected_section or selected_autonomy else '?' }}semestre={{ selected_semester }}{% endif %}"
                    class="inline-flex items-center px-3 py-1.5 rounded-full text-xs font-medium transition-all
                          {% if not selected_category %}bg-primary-600 text-white shadow-sm{% else %}bg-surface-50 text-gray-500 border border-surface-200 hover:border-primary-300 hover:text-primary-600{% endif %}">
                    Toutes
                </a>
                {% for cat in categories %}
                <a href="/mon-carnet?categorie={{ cat.id }}{% if selected_section %}&section={{ selected_section }}{% endif %}{% if selected_autonomy %}&autonomie={{ selected_autonomy }}{% endif %}{% if selected_semester %}&semestre={{ selected_semester }}{% endif %}"
                    class="inline-flex items-center px-3 py-1.5 rounded-full text-xs font-medium transition-all
                          {% if selected_category == cat.id %}bg-primary-600 text-white shadow-sm{% else %}bg-surface-50 text-gray-500 border border-surface-200 hover:border-primary-300 hover:text-primary-600{% endif %}">
                    {{ cat.name }}
                </a>
                {% endfor %}
            </div>
        </div>

        <!-- Autonomy pills -->
        <div>
            <p class="text-xs text-gray-400 mb-2">Niveau d'autonomie</p>
            <div class="flex flex-wrap gap-1.5">
                <a href="/mon-carnet{% if selected_section %}?section={{ selected_section }}{% endif %}{% if selected_category %}{{ '&' if selected_section else '?' }}categorie={{ selected_category }}{% endif %}{% if selected_semester %}{{ '&' if selected_section or selected_category else '?' }}semestre={{ selected_semester }}{% endif %}"
                    class="inline-flex items-center px-3 py-1.5 rounded-full text-xs font-medium transition-all
                          {% if not selected_autonomy %}bg-primary-600 text-white shadow-sm{% else %}bg-surface-50 text-gray-500 border border-surface-200 hover:border-primary-300 hover:text-primary-600{% endif %}">
                    Tous
                </a>
                {% for level, color_class in [("Observé", "bg-amber-400"), ("Assisté", "bg-blue-400"), ("Supervisé",
                "bg-emerald-400"), ("Autonome", "bg-green-500")]
                %}
                {% set is_active = selected_autonomy == level %}
                <a href="/mon-carnet?autonomie={{ level|urlencode }}{% if selected_section %}&section={{ selected_section }}{% endif %}{% if selected_category %}&categorie={{ selected_category }}{% endif %}{% if selected_semester %}&semestre={{ selected_semester }}{% endif %}"
                    class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium transition-all
                          {% if is_active %}bg-primary-600 text-white shadow-sm{% else %}bg-surface-50 text-gray-500 border border-surface-200 hover:border-primary-300 hover:text-primary-600{% endif %}">
                    <span
                        class="w-2 h-2 rounded-full {{ color_class }} {% if is_active %}ring-1 ring-white{% endif %}"></span>
                    {{ level }}
                </a>
                {% endfor %}
            </div>
        </div>

        <!-- Semester pills -->
        {% if user_semesters|length > 0 or hors_stage_count > 0 %}
        <div class="mt-3 pt-3 border-t border-surface-100">
            <p class="text-xs text-gray-400 mb-2">Semestre</p>
            <div class="flex flex-wrap gap-1.5">
                <a href="/mon-carnet{% if selected_section %}?section={{ selected_section }}{% endif %}{% if selected_category %}{{ '&' if selected_section else '?' }}categorie={{ selected_category }}{% endif %}{% if selected_autonomy %}{{ '&' if selected_section or selected_category else '?' }}autonomie={{ selected_autonomy }}{% endif %}"
                    class="inline-flex items-center px-3 py-1.5 rounded-full text-xs font-medium transition-all
                          {% if not selected_semester %}bg-primary-600 text-white shadow-sm{% else %}bg-surface-50 text-gray-500 border border-surface-200 hover:border-primary-300 hover:text-primary-600{% endif %}">
                    Tous
                </a>
                {% for sem in user_semesters %}
                {% set is_active = selected_semester == sem.id|string %}
                <a href="/mon-carnet?semestre={{ sem.id }}{% if selected_section %}&section={{ selected_section }}{% endif %}{% if selected_category %}&categorie={{ selected_category }}{% endif %}{% if selected_autonomy %}&autonomie={{ selected_autonomy }}{% endif %}"
                    class="inline-flex items-center gap-1 px-3 py-1.5 rounded-full text-xs font-medium transition-all
                          {% if is_active %}bg-primary-600 text-white shadow-sm{% else %}bg-surface-50 text-gray-500 border border-surface-200 hover:border-primary-300 hover:text-primary-600{% endif %}">
                    <span class="w-2 h-2 rounded-full
                        {% if sem.phase.value == 'socle' %}bg-blue-400
                        {% elif sem.phase.value == 'approfondissement' %}bg-amber-400
                        {% else %}bg-emerald-400{% endif %}
                        {% if is_active %}ring-1 ring-white{% endif %}"></span>
                    S{{ sem.number }}
                </a>
                {% endfor %}
                {% if hors_stage_count > 0 %}
                {% set is_hors = selected_semester == 'hors' %}
                <a href="/mon-carnet?semestre=hors{% if selected_section %}&section={{ selected_section }}{% endif %}{% if selected_category %}&categorie={{ selected_category }}{% endif %}{% if selected_autonomy %}&autonomie={{ selected_autonomy }}{% endif %}"
                    class="inline-flex items-center gap-1 px-3 py-1.5 rounded-full text-xs font-medium transition-all
                          {% if is_hors %}bg-gray-600 text-white shadow-sm{% else %}bg-surface-50 text-gray-500 border border-surface-200 hover:border-gray-400 hover:text-gray-600{% endif %}">
                    Hors stage
                </a>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Log list -->
    {% if logs %}
    <div class="space-y-3">
        {% for log in logs %}
        {# Determine section-aware label for this log #}
        {% set log_section = log.procedure.category.section %}
        {% if log_section == 'consultation' %}
        {% set type_label = 'cette consultation' %}
        {% elif log_section == 'reanimation' %}
        {% set type_label = 'ce cas de réanimation' %}
        {% elif log_section == 'gesture' %}
        {% set type_label = 'ce geste technique' %}
        {% else %}
        {% set type_label = 'cette intervention' %}
        {% endif %}
        <div class="bg-white rounded-2xl border border-surface-200 overflow-hidden card-hover"
            x-data="{ editing: false }">

            <!-- Normal view -->
            <div x-show="!editing" class="p-4">
                <div class="flex items-start gap-3">
                    <div class="w-10 h-10 rounded-xl flex items-center justify-center text-sm font-bold flex-shrink-0
                        {% if log.autonomy_level == 'Autonome' %}bg-green-100 text-green-700
                        {% elif log.autonomy_level == 'Supervisé' %}bg-emerald-100 text-emerald-700
                        {% elif log.autonomy_level == 'Assisté' %}bg-blue-100 text-blue-700
                        {% elif log.autonomy_level == 'Géré' %}bg-red-100 text-red-700
                        {% elif log.autonomy_level == 'Participé' %}bg-orange-100 text-orange-700
                        {% else %}bg-amber-100 text-amber-700{% endif %}">
                        {% if log.autonomy_level == 'Autonome' %}✓
                        {% elif log.autonomy_level == 'Supervisé' %}◉
                        {% elif log.autonomy_level == 'Assisté' %}◎
                        {% elif log.autonomy_level == 'Géré' %}⚡
                        {% elif log.autonomy_level == 'Participé' %}◎
                        {% else %}○{% endif %}
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-semibold text-gray-800">{{ log.procedure.name }}</p>
                        <p class="text-xs text-gray-400 mt-0.5">
                            {{ log.procedure.category.name }} · {{ log.date.strftime('%d/%m/%Y') }}
                            {% if not log.semester_id %}
                            · <span
                                class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-semibold bg-gray-100 text-gray-500">Hors
                                stage</span>
                            {% elif log.semester %}
                            · <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-semibold
                                {% if log.semester.phase.value == 'socle' %}bg-blue-50 text-blue-600
                                {% elif log.semester.phase.value == 'approfondissement' %}bg-amber-50 text-amber-600
                                {% else %}bg-emerald-50 text-emerald-600{% endif %}">S{{ log.semester.number }}</span>
                            {% endif %}
                        </p>
                        {% if log.notes %}
                        <p class="text-xs text-gray-500 mt-1.5 bg-surface-50 p-2 rounded-lg">{{ log.notes }}</p>
                        {% endif %}
                    </div>
                    <div class="flex items-center gap-1">
                        <span class="hidden sm:inline text-xs px-2 py-1 rounded-full
                            {% if log.autonomy_level == 'Autonome' %}badge-autonomous
                            {% elif log.autonomy_level == 'Supervisé' %}badge-capable
                            {% elif log.autonomy_level == 'Assisté' %}badge-assisted
                            {% elif log.autonomy_level == 'Géré' %}bg-red-100 text-red-700
                            {% elif log.autonomy_level == 'Participé' %}bg-orange-100 text-orange-700
                            {% else %}badge-observed{% endif %}">
                            {{ log.autonomy_level }}
                        </span>
                        <button @click="editing = true"
                            class="p-1.5 text-gray-400 hover:text-primary-600 rounded-lg hover:bg-primary-50 transition"
                            title="Modifier">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                            </svg>
                        </button>
                        <button type="button"
                            @click="$dispatch('open-delete-modal', { id: {{ log.id }}, name: '{{ log.procedure.name|e }}', typeLabel: '{{ type_label }}', date: '{{ log.date.strftime('%d/%m/%Y') }}' })"
                            class="p-1.5 text-gray-400 hover:text-red-500 rounded-lg hover:bg-red-50 transition"
                            title="Supprimer">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Edit view -->
            <div x-show="editing" x-cloak class="p-4 bg-primary-50/30">
                <form method="post" action="/gestes/{{ log.id }}/modifier" class="space-y-3">
                    <div class="flex items-center justify-between mb-1">
                        <h3 class="text-sm font-semibold text-gray-700">Modifier · {{ log.procedure.name }}</h3>
                        <button type="button" @click="editing = false"
                            class="text-xs text-gray-500 hover:text-gray-700">Annuler</button>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">Date</label>
                        <input type="date" name="date" value="{{ log.date.strftime('%Y-%m-%d') }}" required
                            class="w-full px-3 py-2 rounded-lg border border-surface-300 bg-white text-sm focus:outline-none focus:ring-2 focus:ring-primary-300">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">Niveau d'autonomie</label>
                        <select name="autonomy_level" required
                            class="w-full px-3 py-2 rounded-lg border border-surface-300 bg-white text-sm focus:outline-none focus:ring-2 focus:ring-primary-300">
                            {% for level in autonomy_levels %}
                            <option value="{{ level.value }}" {% if level.value==log.autonomy_level %}selected{% endif
                                %}>{{ level.value }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">Notes</label>
                        <textarea name="notes" rows="2"
                            class="w-full px-3 py-2 rounded-lg border border-surface-300 bg-white text-sm focus:outline-none focus:ring-2 focus:ring-primary-300 resize-none">{{ log.notes or '' }}</textarea>
                    </div>
                    <button type="submit"
                        class="w-full py-2 bg-primary-600 text-white text-sm font-medium rounded-lg hover:bg-primary-700 transition">
                        Enregistrer les modifications
                    </button>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="bg-white rounded-2xl border border-surface-200 p-10 text-center">
        <div class="w-14 h-14 bg-surface-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
            <svg class="w-7 h-7 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
            </svg>
        </div>
        {% if selected_category or selected_autonomy or selected_semester or selected_section %}
        <p class="text-sm text-gray-500">Aucun acte ne correspond à ces filtres.</p>
        <a href="/mon-carnet"
            class="inline-block mt-3 text-xs text-primary-600 font-medium hover:underline">Réinitialiser les filtres</a>
        {% else %}
        <p class="text-sm text-gray-500">Votre carnet est vide.</p>
        <p class="text-xs text-gray-400 mt-1">Appuyez sur <strong>+</strong> depuis le tableau de bord pour ajouter un
            acte.</p>
        {% endif %}
    </div>
    {% endif %}

    <!-- Custom Delete Confirmation Modal -->
    <div x-data="deleteModal()" @open-delete-modal.window="open($event.detail)" x-show="show"
        x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100" x-transition:leave="transition ease-in duration-150"
        x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0"
        class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/40" @click.self="show = false" x-cloak>

        <div x-show="show" x-transition:enter="transition ease-out duration-200"
            x-transition:enter-start="scale-95 opacity-0" x-transition:enter-end="scale-100 opacity-100"
            x-transition:leave="transition ease-in duration-100" x-transition:leave-start="scale-100 opacity-100"
            x-transition:leave-end="scale-95 opacity-0"
            class="bg-white rounded-2xl shadow-xl max-w-sm w-full p-6 text-center">

            <!-- Trash icon -->
            <div class="w-12 h-12 rounded-xl bg-red-50 flex items-center justify-center mx-auto mb-4">
                <svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
            </div>

            <h3 class="text-base font-semibold text-gray-800 mb-1" x-text="'Supprimer ' + typeLabel + ' ?'"></h3>
            <p class="text-sm text-gray-500 mb-5" x-text="name + ' — ' + date"></p>

            <div class="flex gap-3">
                <button @click="show = false"
                    class="flex-1 py-2.5 text-sm font-medium text-gray-600 bg-surface-100 rounded-xl hover:bg-surface-200 transition">
                    Annuler
                </button>
                <form :action="'/gestes/' + logId + '/supprimer'" method="post" class="flex-1">
                    <button type="submit"
                        class="w-full py-2.5 text-sm font-medium text-white bg-red-500 rounded-xl hover:bg-red-600 transition">
                        Supprimer
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- FAB (same as dashboard for quick logging) -->
    <a href="/tableau-de-bord"
        class="fixed bottom-6 right-6 w-14 h-14 bg-gradient-to-br from-primary-500 to-primary-600 text-white rounded-full shadow-lg shadow-primary-300/40 flex items-center justify-center hover:scale-105 active:scale-95 transition-transform z-50">
        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4" />
        </svg>
    </a>
</div>
{% endblock %}

{% block scripts %}
<script>
    function logbookApp() {
        return {}
    }

    function deleteModal() {
        return {
            show: false,
            logId: null,
            name: '',
            typeLabel: '',
            date: '',
            open(detail) {
                this.logId = detail.id;
                this.name = detail.name;
                this.typeLabel = detail.typeLabel;
                this.date = detail.date;
                this.show = true;
            }
        }
    }
</script>
{% endblock %}